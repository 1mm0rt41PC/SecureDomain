#NAMING GROUP:
#    GPO Name:
#        Comment: |
#            Test
#        Script: |
#            $domainDontrollerList = (Get-DnsClientGlobalSetting).SuffixSearchList | foreach {
#                Resolve-DnsName -Type ALL -Name _ldap._tcp.dc._msdcs.$_
#            } | foreach {
#                $_.IP4Address
#            } | sort -unique
#        Hive:
#            HKLM\System\CurrentControlSet\Services\Netlogon\Parameters:
#                DisablePasswordChange: DWord:0
#                MaximumPasswordAge: DWord:30
#        Fw:
#            Enabled: True
#            NotifyOnListen: False
#            DefaultOutboundAction: Allow
#            DefaultInboundAction: Block
#            AllowInboundRules: True
#            AllowLocalFirewallRules: False
#            AllowLocalIPsecRules: True
#            AllowUnicastResponseToMulticast: True
#            LogAllowed: True
#            LogBlocked: True
#            LogIgnored: False
#            LogFileName: "%windir%\\system32\\logfiles\\pfirewall.log"
#            LogMaxSizeKilobytes: 32767
#            #Outbound-Block: 5353/UDP
#            Outbound-Block:
#                IPv6: "*/41"
#            Outbound-Allow:
#                Allow all TCP: "*/TCP"
#                Allow VPN only: "$IP_VPN_ADMIN:*/*"
#                Deny IE:
#                    Program:
#                        - C:\Program Files\Internet Explorer\iexplore.exe
#                        - C:\Program Files (x86)\Internet Explorer\iexplore.exe
#                    RemoteAdress: $IPForInternet
#                    Protocol: TCP
#            Inbound-Block:
#                Allow RDP: 3389/TCP
#            Inbound-Allow:
#                Allow HTTPS for all: "*:443/TCP"
#        Service General Setting:
#            Spooler: 4
#        Event Audit:
#            AuditSystemEvents: 3
#            AuditLogonEvents: 3
#            AuditObjectAccess: 3
#            AuditPrivilegeUse: 3
#            AuditPolicyChange: 3
#            AuditAccountManage: 3
#            AuditProcessTracking: 3
#            AuditDSAccess: 3
#            AuditAccountLogon: 3
#        Privilege Rights:
#            SeMachineAccountPrivilege: adm_toto,adm_titi,S-1-5-32-544
#            SeInteractiveLogonRight: "*S-1-5-32-544"
#        Group Membership:
#            S-1-5-32-544__Memberof: xxx
#            S-1-5-32-544__Members: xxx
#        GPLink: $LDAP_DN
#        Tasks:
#           My Task:
#               Type: ImmediateTask
#               Command: powershell
#               CommandArguments: -exec bypass -nop -Command "whoami | Out-File C:\Temp\test.txt"
#               RunAs: S-1-5-18
#               Context: Machine
#               disallowStartIfOnBatteries: false
#               stopIfGoingOnBatteries: false
#               executionTimeLimit: 1                   # in hours
#               restartOnFailureInterval: 10                   # in minutes
#               restartOnFailureCount: 3
#               runOnlyIfNetworkAvailable: false
#           My Task2:
#               Type: Task
#               Command: powershell
#               CommandArguments: -exec bypass -nop -Command "whoami | Out-File C:\Temp\test.txt"
#               RunAs: S-1-5-18
#               Context: Machine
#               StartEveryDayAt: 9
#               disallowStartIfOnBatteries: false
#               stopIfGoingOnBatteries: false
#               executionTimeLimit: 1                   # in hours
#               restartOnFailureInterval: 10                   # in minutes
#               restartOnFailureCount: 3
#               runOnlyIfNetworkAvailable: false
#               randomDelay: 10      # in minutes. if 0 => no random delay


__main__:
    GlobalScript:
        Script: |
            $IPForInternet=@('1.0.0.0-9.255.255.255',
            '11.0.0.0-100.63.255.255',
            '100.128.0.0-126.255.255.255',
            '128.0.0.0-169.253.255.255',
            '169.255.0.0-172.15.255.255',
            '172.32.0.0-191.255.255.255',
            '192.0.1.0-192.0.1.255',
            '192.0.3.0-192.167.255.255',
            '192.169.0.0-198.17.255.255',
            '198.20.0.0-198.51.99.255',
            '198.51.101.0-203.0.112.255',
            '203.0.114.0-255.255.255.254')

DomainController_Config:
    ###########################################################################
    CreateOU:
        Script: |
            New-ADOrganizationalUnit -Name "_AllUsers" -Path "$LDAP_DN"
            New-ADOrganizationalUnit -Name "_CriticalUsers" -Path "$LDAP_DN"
            New-ADOrganizationalUnit -Name "__DomainAdministrators__" -Path "OU=_CriticalUsers,$LDAP_DN"
            New-ADOrganizationalUnit -Name "__LocalAdministrators__" -Path "OU=_CriticalUsers,$LDAP_DN"
            New-ADOrganizationalUnit -Name "ALL" -Path "OU=__LocalAdministrators__,OU=_CriticalUsers,$LDAP_DN"
            New-ADOrganizationalUnit -Name "DBA" -Path "OU=__LocalAdministrators__,OU=_CriticalUsers,$LDAP_DN"
            New-ADOrganizationalUnit -Name "__EXTERNAL__" -Path "OU=_AllUsers,$LDAP_DN"
            New-ADOrganizationalUnit -Name "__Groups__" -Path "OU=_AllUsers,$LDAP_DN"
            New-ADOrganizationalUnit -Name "_AllComputers" -Path "$LDAP_DN"
            New-ADOrganizationalUnit -Name "Laptops" -Path "OU=_AllComputers,$LDAP_DN"
            New-ADOrganizationalUnit -Name "Workstations" -Path "OU=_AllComputers,$LDAP_DN"
            New-ADOrganizationalUnit -Name "Servers" -Path "OU=_AllComputers,$LDAP_DN"
            New-ADOrganizationalUnit -Name "Database" -Path "OU=Servers,OU=_AllComputers,$LDAP_DN"
            New-ADOrganizationalUnit -Name "DHCP" -Path "OU=Servers,OU=_AllComputers,$LDAP_DN"
            New-ADOrganizationalUnit -Name "DNS" -Path "OU=Servers,OU=_AllComputers,$LDAP_DN"
            New-ADOrganizationalUnit -Name "FileServer" -Path "OU=Servers,OU=_AllComputers,$LDAP_DN"
            New-ADOrganizationalUnit -Name "IIS-HTTP" -Path "OU=Servers,OU=_AllComputers,$LDAP_DN"
            New-ADOrganizationalUnit -Name "ServerWithJobInBackgroundWithoutOpenPort" -Path "OU=Servers,OU=_AllComputers,$LDAP_DN"
            New-ADOrganizationalUnit -Name "TerminalServer" -Path "OU=Servers,OU=_AllComputers,$LDAP_DN"
            redircmp "OU=_AllComputers,$LDAP_DN"
            redirusr "OU=_AllUsers,$LDAP_DN"
    ###########################################################################
    CreateBasicGroups:
        Script: |
            New-ADGroup -Name PRIV_DBA_ADMIN -Path "OU=_CriticalUsers,$LDAP_DN" -GroupCategory Security -GroupScope DomainLocal
            New-ADGroup -Name PRIV_INTERACT_LAPTOP -Path "OU=_AllUsers,$LDAP_DN" -GroupCategory Security -GroupScope DomainLocal
            New-ADGroup -Name PRIV_INTERACT_WORKSTATION -Path "OU=_AllUsers,$LDAP_DN" -GroupCategory Security -GroupScope DomainLocal
            New-ADGroup -Name PRIV_LOCAL_ADM -Path "OU=_CriticalUsers,$LDAP_DN" -GroupCategory Security -GroupScope DomainLocal
            New-ADGroup -Name PRIV_ENROLL_MACHINE -Path "OU=_CriticalUsers,$LDAP_DN" -GroupCategory Security -GroupScope DomainLocal
    ###########################################################################
    Enable the Recycle Bin:
        Script: |
            Import-Module ActiveDirectory
            Enable-ADOptionalFeature -Identity "CN=Recycle Bin Feature,CN=Optional Features,CN=Directory Service,CN=Windows NT,CN=Services,CN=Configuration,$LDAP_DN" -Scope ForestOrConfigurationSet -Target "$domain" -Confirm:$false
    ###########################################################################
    "Install 'BitLocker recovery tab'":
        Script: |
            Install-WindowsFeature RSAT-Feature-Tools-BitLocker-BdeAducExt
    ###########################################################################
    Password policy:
        Script: |
            $Policies= @{
                Identity=$env:UserDomain;
                LockoutDuration='00:30:00';
                LockoutThreshold=5;
                LockoutObservationWindow='00:20:00';
                ComplexityEnabled=$true;
                ReversibleEncryptionEnabled=$False;
                MaxPasswordAge='180.00:00:00';
                MinPasswordLength=15;
                PasswordHistoryCount=10;
            }
            Set-ADDefaultDomainPasswordPolicy @Policies
            
    ###########################################################################
    Enable-Advenced-AD-Password-Protection:
        Script: |
            # https://blog.lithnet.io/2019/01/lppad-1.html
            curl.exe -L https://github.com/lithnet/ad-password-protection/releases/latest/download/Lithnet.ActiveDirectory.PasswordProtection.msi --output Lithnet.ActiveDirectory.PasswordProtection.msi
            /quiet /qn ALLUSERS=2 
            msiexec.exe /i Lithnet.ActiveDirectory.PasswordProtection.msi /quiet /qn /norestart REBOOT=ReallySuppress ALLUSERS=2 
            # Download the latest version of the NTLM passwords from the haveibeenpwned.com pwned password list (scroll to the end). Make sure you get the "NTLM Ordered by hash" version. Use the torrent link if you are able to so, as this helps minimize bandwidth and costs. Uncompress the file, and place it on your server to import later in the process.
            curl.exe -L https://downloads.pwnedpasswords.com/passwords/pwned-passwords-ntlm-ordered-by-hash-v8.7z --output hash.7z
            7z x hash.7z
            Import-Module LithnetPasswordProtection
            Open-Store 'C:\Program Files\Lithnet\Active Directory Password Protection\Store'
            Import-CompromisedPasswordHashes -Filename hash\pwned-passwords-ntlm-ordered-by-hash-*.txt
    ###########################################################################
    Admin account cannot be delegated:
        Script: |
            $UID__DOMAIN = (Get-ADDomain).DomainSID.Value
            # DomainAdmin=512, EnterpriseAdmin=519, AccountOperator=548, BackupOperator=551, PrintOperator=550, Replicator=552, SchemaAdministrators=518
            # Admin account cannot be delegated
            @(512,519,548,551,550,552,518) | foreach {
                $grp = Get-ADGroup -Filter "SID -eq '$UID__DOMAIN-$_' -or SID -eq 'S-1-5-32-$_'"
                Write-Host "Set account cannot be delegated in >$($grp.Name)<"
                $target = $grp | Get-ADGroupMember -Recursive | Get-ADUser -Properties AccountNotDelegated | Where-Object {-not $_.AccountNotDelegated -and $_.objectClass -eq 'user'}
                $target | Select distinguishedName,SamAccountName,AccountNotDelegated
                $target | Set-ADUser -AccountNotDelegated $true
            }
            $grp = Get-ADGroup DnsAdmins
            Write-Host "Set account cannot be delegated in >$($grp.Name)<"
            $target = $grp | Get-ADGroupMember -Recursive | Get-ADUser -Properties AccountNotDelegated | Where-Object {-not $_.AccountNotDelegated -and $_.objectClass -eq 'user'}
            $target | Select distinguishedName,SamAccountName,AccountNotDelegated
            $target | Set-ADUser -AccountNotDelegated $true            
    ###########################################################################
    Split DC FSMO role:
        Script: |
            Write-Host "Doc: https://activedirectorypro.com/transfer-fsmo-roles/"
            $LDAP_DN = ( [ADSI]"LDAP://RootDSE" ).defaultNamingContext.Value
            Write-Warning "Current FSMO"
            netdom query fsmo
            $dc = Get-ADComputer -Filter * -SearchBase "OU=Domain Controllers,$LDAP_DN" | where { $_.Enabled -eq $true }
            if( $dc.Count -gt 1 ){
                Move-ADDirectoryServerOperationMasterRole -Identity $dc[(0)%$dc.Count].Name PDCEmulator
                Move-ADDirectoryServerOperationMasterRole -Identity $dc[(1)%$dc.Count].Name RIDMaster
                Move-ADDirectoryServerOperationMasterRole -Identity $dc[(2)%$dc.Count].Name Infrastructuremaster
                Move-ADDirectoryServerOperationMasterRole -Identity $dc[(3)%$dc.Count].Name DomainNamingmaster
                Move-ADDirectoryServerOperationMasterRole -Identity $dc[(4)%$dc.Count].Name SchemaMaster
                Write-Warning "New FSMO"
                netdom query fsmo
            }else{
                Write-Warning "Unable to change FSMO ! Not Enough server"
            }
    ###########################################################################
    Set timezone to W. Europe Standard Time:
        ShortPrefix: GPO,Computer&User
        Script: |
            tzutil /s 'W. Europe Standard Time'
            reg add "HKCU\Control Panel\International" /v sLongDate /d "dddd, MMMM d, yyyy" /t REG_SZ /f
            reg add "HKCU\Control Panel\International" /v sShortDate /d "MM/dd/yyyy" /t REG_SZ /f
            reg add "HKCU\Control Panel\International" /v sShortTime /d "HH:mm" /t REG_SZ /f
            reg add "HKCU\Control Panel\International" /v sTimeFormat /d "HH:mm:ss" /t REG_SZ /f
            reg add "HKCU\Control Panel\International" /v sYearMonth /d "MMMM yyyy" /t REG_SZ /f
            reg add "HKCU\Control Panel\International" /v iFirstDayOfWeek /d "0" /t REG_SZ /f

            reg add "HKEY_USERS\.DEFAULT\Control Panel\International" /v sLongDate /d "dddd, MMMM d, yyyy" /t REG_SZ /f
            reg add "HKEY_USERS\.DEFAULT\Control Panel\International" /v sShortDate /d "MM/dd/yyyy" /t REG_SZ /f
            reg add "HKEY_USERS\.DEFAULT\Control Panel\International" /v sShortTime /d "HH:mm" /t REG_SZ /f
            reg add "HKEY_USERS\.DEFAULT\Control Panel\International" /v sTimeFormat /d "HH:mm:ss" /t REG_SZ /f
            reg add "HKEY_USERS\.DEFAULT\Control Panel\International" /v sYearMonth /d "MMMM yyyy" /t REG_SZ /f
            reg add "HKEY_USERS\.DEFAULT\Control Panel\International" /v iFirstDayOfWeek /d "0" /t REG_SZ /f
        Hive:
            HKCU\Control Panel\International: &default_tz
                sLongDate: ExpandString:dddd, MMMM d, yyyy
                sShortDate: ExpandString:MM/dd/yyyy
                sShortTime: ExpandString:HH:mm
                sTimeFormat: ExpandString:HH:mm:ss
                sYearMonth: ExpandString:MMMM yyyy
                iFirstDayOfWeek: ExpandString:0
            HKLM\Control Panel\International: *default_tz
    ###########################################################################
    Force DC to switch on Domain Profile Firewall:
        Comment: To force firewall profile to domain for DC
        ShortPrefix: GPO,Computer
        Hive:
            HKLM\SYSTEM\CurrentControlSet\Services\nlasvc:
                Start: DWord:2
                DelayedAutostart: DWord:1
        GPLink: OU=Domain Controllers,$LDAP_DN
    ###########################################################################
    PingCastle-fix-PreWin2000Other:
        Script: |
            # SamAccountName	: Accès compatible pré-Windows 2000
            # SID			   : S-1-5-32-554
            $preWin200 = Get-ADGroup -Filter * | where { $_.SID -eq 'S-1-5-32-554' }
            $preWin200 | get-ADGroupMember | foreach { $preWin200 | Remove-ADGroupMember -Members $_.SamAccountName }
            
    Block PetitPotam:
        Script: |
            $rr = (netsh rpc filter show filter).Replace(' ','') ;
            if( -not ($rr -Like "*c681d488*" -Or $rr -Like "*df1941c5*") ){
                @'
            rpc
            filter
            add rule layer=um actiontype=permit
            add condition field=if_uuid matchtype=equal data=c681d488-d850-11d0-8c52-00c04fd90f7e
            add condition field=remote_user_token matchtype=equal data=D:(A;;CC;;;DA)
            add filter
            add rule layer=um actiontype=block
            add condition field=if_uuid matchtype=equal data=c681d488-d850-11d0-8c52-00c04fd90f7e
            add filter
            add rule layer=um actiontype=permit
            add condition field=if_uuid matchtype=equal data=df1941c5-fe89-4e79-bf10-463657acf44d
            add condition field=remote_user_token matchtype=equal data=D:(A;;CC;;;DA)
            add filter
            add rule layer=um actiontype=block
            add condition field=if_uuid matchtype=equal data=df1941c5-fe89-4e79-bf10-463657acf44d
            add filter
            quit
            '@ | Out-File -Encoding ASCII C:\Windows\Temp\rr.txt
                netsh -f C:\Windows\Temp\rr.txt
                write-Host 'Patching'
            }
            write-Host 'Patched'




###############################################################################
Hardening:
    ###########################################################################
    Force NTLMv2 and Kerberos - Disable LM,NTLMv1:
        ShortPrefix: GPO,Computer
        Comment: |
            Force usage of NTLMv2 and Kerberos
            Disable LM and NTLMv1
            
            Side effect: Can block Windows XP and 2003 - Please audit before !
            If Disabled: Cancel NTLM hardening
        Hive:
            HKLM\System\CurrentControlSet\Control\Lsa:
                NoLMHash: DWord:1
                LmCompatibilityLevel: DWord:5
    ###########################################################################
    Enable TLS1.3&TLS1.2&TLS1.1:
        ShortPrefix: GPO,Computer
        Comment: |
            Enable TLS1.1, TLS 1.2 and TLS 1.3
            Values:
                0x00000008	Enable SSL 2.0
                0x00000020	Enable SSL 3.0
                0x00000080	Enable TLS 1.0
                0x00000200	Enable TLS 1.1
                0x00000800	Enable TLS 1.2
                0x00002000	Enable TLS 1.3
            
            Side effect: None
            If Disabled: an block some SSL/TLS connections
        Hive:
            HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Internet Settings:
                SecureProtocols: DWord:10752
            HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Internet Settings\WinHttp:
                DefaultSecureProtocols: DWord:10752
            HKLM\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\Internet Settings\WinHttp:
                DefaultSecureProtocols: DWord:10752
            HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.3\Client: &tls_config
                DisabledByDefault: DWord:0
                Enabled: DWord:1
            HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.2\Client: *tls_config
            HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.1\Client: *tls_config
            HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.3\Server: *tls_config
            HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.2\Server: *tls_config
            HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.1\Server: *tls_config
    ###########################################################################
    UAC configuration:
        ShortPrefix: GPO,Computer
        Hive:
            HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System:
                FilterAdministratorToken: DWord:1 # 2.3.17.1 UAC - Ensure 'User Account Control: Admin Approval Mode for the Built-in Administrator account' is set to 'Enabled'
                # 18.3.1 Ensure 'Apply UAC restrictions to local accounts on network logons' is set to 'Enabled'
                # 0=This value builds a filtered token. It's the default value. The administrator credentials are removed.
                # 1=This value builds an elevated token.
                LocalAccountTokenFilterPolicy: DWord:0
        GPLink: OU=Domain Controllers,$LDAP_DN
    ###########################################################################
    RDP server configuration:
        ShortPrefix: GPO,Computer
        Hive:
            HKLM\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services:
                KeepAliveInterval: DWord:1
                DeleteTempDirsOnExit: DWord:1 # 18.9.59.3.11.1 (L1) Ensure 'Do not delete temp folders upon exit' is set to 'Disabled' (Scored)
                SecurityLayer: DWord:2 # 18.9.59.3.9.3 (L1) Ensure 'Require use of specific security layer for remote (RDP) connections' is set to 'Enabled: SSL' (Scored)
                UserAuthentication: DWord:1 # Require user authentication for remote connections by using Network Level Authentication
                MaxIdleTime: DWord:900000
                MaxDisconnectionTime: DWord:900000 # 18.9.59.3.10.2 Ensure 'Set time limit for disconnected sessions' is set to 'Enabled: 15 minute'
                RemoteAppLogoffTimeLimit: DWord:300000
                fEncryptRPCTraffic: DWord:1 # Require secure RPC communication
                MinEncryptionLevel: DWord:3 # 18.9.59.3.9.5 (L1) Ensure 'Set client connection encryption level' is set to 'Enabled: High Level' (Scored)
                AllowEncryptionOracle: DWord:0 # Client applications which use CredSSP will not be able to fall back to the insecure versions and services using CredSSP will not accept unpatched clients.
            HKLM\System\CurrentControlSet\Control\Lsa:
                DisableDomainCreds: DWord:1 # Network_access_Do_not_allow_storage_of_passwords_and_credentials_for_network_authentication
        GPLink: $LDAP_DN
    RDP Client configuration:
        ShortPrefix: GPO,Computer
        Hive:
            HKEY_CLASSES_ROOT\.RDP:
                (Default): String:txtfile
    ###########################################################################
    LogSystem:
        ShortPrefix: GPO,Computer
        Comment: |
            Windows logs configuration:
            - type of logs
            - size of logs
            
            If disabled: Lost logs information
        Event Audit:
            AuditSystemEvents: 3
            AuditLogonEvents: 3
            AuditObjectAccess: 3
            AuditPrivilegeUse: 3
            AuditPolicyChange: 3
            AuditAccountManage: 3
            AuditProcessTracking: 3
            AuditDSAccess: 3
            AuditAccountLogon: 3
        Hive:
            HKLM\System\CurrentControlSet\Control\Lsa\MSV1_0:
                # Audit incoming NTLM traffic: Enable auditing for all accounts
                # to view => [System[(EventID=4624)]] and also Get-WinEvent -FilterHashtable @{ LogName = 'Microsoft-Windows-NTLM/Operational' ; Id = 8001,8002 }
                AuditReceivingNTLMTraffic: DWord:1
            HKLM\System\CurrentControlSet\Services\Netlogon\Parameters:
                # Audit NTLM Authentication in this domain: Enable all
                # 0=>Disable, 1=>"Enable for domain accounts to domain servers", 2=>"Enable for domain accounts", 3=>"Enable for domain servers", 7=>"Enable all"
                AuditNTLMInDomain: DWord:7
            HKLM\Software\Policies\Microsoft\Windows\PowerShell\ModuleLogging:
                EnableModuleLogging: DWord:1
            HKCU\Software\Policies\Microsoft\Windows\PowerShell\Transcription:
                EnableTranscripting: DWord:1
                EnableInvocationHeader: DWord:1
                OutputDirectory: ExpandString:C:\Windows\Powershell.log
            HKCU\Software\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging:
                EnableScriptBlockLogging: DWord:1
            HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\WINEVT\Channels\Microsoft-Windows-Dhcp-Client/Operational:
                Enabled: DWord:1
            HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\WINEVT\Channels\Microsoft-Windows-Dhcpv6-Client/Operational:
                Enabled: DWord:1
            HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\WINEVT\Channels\Microsoft-Windows-DNS-Client/Operational:
                Enabled: DWord:1
    ###########################################################################
    Auto lock session after 15min:
        ShortPrefix: GPO,Computer
        Hive:
            HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System:
                InactivityTimeoutSecs: DWord:900 # 2.3.7.3 Interactive logon: Machine inactivity limit (Scored)
        GPLink: $LDAP_DN
    ###########################################################################
    "Deny anonymous SMB (Block CobaltStrike from using \\evil.kali\tmp$\becon.exe)":
        ShortPrefix: GPO,Computer
        Hive:
            HKLM\SOFTWARE\Policies\Microsoft\Windows\LanmanWorkstation:
                AllowInsecureGuestAuth: DWord:0
        GPLink: $LDAP_DN
    
    ###########################################################################
    "WinRM - Configuration":
        Comment: |
            WinRM configuration:
            - Disable basic auth & Negotiate
            - Force kerberos auth
            - Enable protection against relay
            
            If disabled: Restore WinRM default configuration
        ShortPrefix: GPO,Computer
        Hive:
            HKLM\SOFTWARE\Policies\Microsoft\Windows\WinRM\Service:
                AllowBasic: DWord:0
                AllowDigest: DWord:0
                AllowKerberos: DWord:1
                CbtHardeningLevel: String:Strict
                AllowNegotiate: DWord:0
            HKLM\SOFTWARE\Policies\Microsoft\Windows\WinRM\Client:
                AllowBasic: DWord:0
                AllowDigest: DWord:0
                AllowKerberos: DWord:1
                CbtHardeningLevel: String:Strict
                AllowNegotiate: DWord:0
        Fw:
            Inbound-Allow:
                Protocol: TCP
                LocalPort: "@(5985,5986)"
                
    ###########################################################################
    "WSUS - Configuration with HTTPS":
        Comment: |
            WSUS configuration:
            - Force HTTPS
            
            If disabled: Restore WSUS default configuration
        ShortPrefix: GPO,Computer
        Hive:
            HKLM\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate:
                WUServer: String:https://xxxxx.corp.lo:8531
                WUStatusServer: String:https://xxxxx.corp.lo:8531
            HKLM\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU:
                UseWUServer: DWord:1
                NoAutoUpdate: DWord:0
                # AUOptions=2 => Notify download & Notify install
                AUOptions: DWord:2
                ScheduledInstallDay: DWord:0
                ScheduledInstallTime: DWord:3
                
    ###########################################################################
    Print spooler configuration:
        ShortPrefix: GPO,Computer
        Comment: |
            Configure spooler to avoid priviledge escalation.
            
            Side effect: Block installation of new printers ! Package your printer drivers in the image or via WSUS/SCCM
            If disabled: Lost logs information
        Hive:
            # Limits print driver installation to Administrators
            HKLM\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint:
                RestrictDriverInstallationToAdministrators: DWord:1
                # Show warning and elevation prompt (default).
                NoWarningNoElevationOnInstall: DWord:0
                # Show warning and elevation prompt (default).
                UpdatePromptSettings: DWord:0
                # Users can point and print to any machine (default).
                InForest: DWord:0
                # Users can point and print to any server (default).
                TrustedServers: DWord:1
            HKLM\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PackagePointAndPrint:
                # Package Point and print - Only use Package Point and Print
                PackagePointAndPrintOnly: DWord:1
                # Package Point and print - Approved servers > PackagePointAndPrintServerList
                PackagePointAndPrintServerList: DWord:1

Log:
    ###########################################################################
    LSA & NTLM Audit Mode:
        ShortPrefix: GPO,Computer
        Comment: |
            Windows logs configuration:
            - Audit LSA protection (RunAsPPL)
            - Audit incoming NTLM traffic for all accounts:
                to view =>
                Get-WinEvent -Filterxml @'
                <QueryList>
                 <Query Id="0" Path="security">
                  <Select Path="security">
                   *[System[(EventID=4624)]]
                    and
                    (
                     *[EventData[Data[@Name='AuthenticationPackageName']!='Kerberos']]
                     and
                     *[EventData[Data[@Name='LmPackageName']!='NTLM V2']]
                   )
                  </Select>
                 </Query>
                </QueryList>
                '@
                and also Get-WinEvent -FilterHashtable @{ LogName = 'Microsoft-Windows-NTLM/Operational' ; Id = 8001,8002 }            
            
            If disabled: Lost logs information
        Hive:
            HKLM\SYSTEM\CurrentControlSet\services\Netlogon\Parameters:
                # Audit NTLM Authentication in this domain: Enable all
                # 0=>Disable, 1=>"Enable for domain accounts to domain servers", 2=>"Enable for domain accounts", 3=>"Enable for domain servers", 7=>"Enable all"
                AuditNTLMInDomain: DWord:7
            HKLM\SYSTEM\CurrentControlSet\Control\Lsa\MSV1_0:
                # Audit incoming NTLM traffic: Enable auditing for all accounts
                # to view => [System[(EventID=4624)]] and also Get-WinEvent -FilterHashtable @{ LogName = 'Microsoft-Windows-NTLM/Operational' ; Id = 8001,8002 }
                AuditReceivingNTLMTraffic: DWord:1
                RestrictSendingNTLMTraffic: DWord:1
            HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\LSASS.exe:
                AuditLevel: DWord:8

###############################################################################
Priv:
    ###########################################################################
    "Groups allowed to link new computers to the domain (PRIV_ENROLL_MACHINE)":
        Script: |
            New-ADGroup -Name PRIV_ENROLL_MACHINE -Path "OU=_CriticalUsers,$LDAP_DN" -GroupCategory Security -GroupScope Universal
            # Avoid machine added by users
            Set-ADDomain (Get-ADDomain).distinguishedname -Replace @{"ms-ds-MachineAccountQuota"="0"}
            # List all creators
            Get-ADComputer -Filter * -Properties ms-DS-CreatorSID | Where-Object -FilterScript { $_."ms-DS-CreatorSID" -ne $Null } | Format-Table -AutoSize -Property Name,@{Label='User';Expression={(New-Object System.Security.Principal.SecurityIdentifier($_."mS-DS-CreatorSID".Value)).Translate([System.Security.Principal.NTAccount]).Value}}
            dsacls.exe "OU=_AllComputers,$(([ADSI]'LDAP://RootDSE').defaultNamingContext.Value)" /G "PRIV_ENROLL_MACHINE:CC;computer"
            # Check if MachineAccountQuota=0           
            Get-ADObject ((Get-ADDomain).distinguishedname) -Properties ms-DS-MachineAccountQuota
            ### Add manualy the group or users allowed to add machine
            ### Group Policy Management Console (gpmc.msc) > Domain Controllers OU > Domain Controllers Policy > Computer Configuration > Policies > Windows Settings > Security Settings > Local Policies > User Rights Assigments > Add workstations to domain
            ### And https://www.appuntidallarete.com/you-have-exceeded-the-maximum-number-of-computer-accounts/
            ### https://www.moderndeployment.com/correct-domain-join-account-permissions/
        #Privilege Rights:
        #    SeMachineAccountPrivilege: PRIV_ENROLL_MACHINE
        #GPLink: OU=Domain Controllers,$LDAP_DN -Enforced
    
    ###########################################################################
    "Allow session for groups PRIV_INTERACT_WORKSTATION,PRIV_LOCAL_ADM":
        ShortPrefix: GPO,Computer
        Privilege Rights:
            SeInteractiveLogonRight: S-1-5-32-544, PRIV_LOCAL_ADM, PRIV_INTERACT_WORKSTATION
    
    ###########################################################################
    "Allow session for groups PRIV_INTERACT_LAPTOP,PRIV_LOCAL_ADM":
        ShortPrefix: GPO,Computer
        Privilege Rights:
            SeInteractiveLogonRight: S-1-5-32-544, PRIV_LOCAL_ADM, PRIV_INTERACT_LAPTOP

    ###########################################################################
    "Allow RDP for group PRIV_REMOTE_TS":
        ShortPrefix: GPO,Computer
        Privilege Rights:
            SeInteractiveLogonRight: S-1-5-32-544, PRIV_REMOTE_TS, PRIV_LOCAL_ADM
            SeNetworkLogonRight: S-1-5-32-544, PRIV_REMOTE_TS, PRIV_LOCAL_ADM
    
    ###########################################################################    
    "AdminLocal for group PRIV_LOCAL_ADM":
        ShortPrefix: GPO,Computer
        Group Membership:
            S-1-5-32-544__Memberof: ""
            S-1-5-32-544__Members: PRIV_LOCAL_ADM
        
    ###########################################################################
    "DomainAdmin not allowed to connect":
        ShortPrefix: GPO,Computer
        Script: |
            $UID__DOMAIN = (Get-ADDomain).DomainSID.Value
        Privilege Rights:
            SeDenyNetworkLogonRight: S-1-5-32-546, $UID__DOMAIN-514, $UID__DOMAIN-501, $UID__DOMAIN-512, $UID__DOMAIN-519
            SeDenyInteractiveLogonRight: S-1-5-32-546, $UID__DOMAIN-514, $UID__DOMAIN-501, $UID__DOMAIN-512, $UID__DOMAIN-519
            SeDenyServiceLogonRight: S-1-5-32-546, $UID__DOMAIN-514, $UID__DOMAIN-501, $UID__DOMAIN-512, $UID__DOMAIN-519
            SeDenyBatchLogonRight: S-1-5-32-546, $UID__DOMAIN-514, $UID__DOMAIN-501, $UID__DOMAIN-512, $UID__DOMAIN-519
            SeDenyRemoteInteractiveLogonRight: S-1-5-32-546, $UID__DOMAIN-514, $UID__DOMAIN-501, $UID__DOMAIN-512, $UID__DOMAIN-519


###############################################################################
Firewall:
    FW-TEST:
        Fw:
            Outbound-Allow:
                toto:
                    Program:
                        - C:\Program Files\Internet Explorer\iexplore.exe
                        - C:\Program Files (x86)\Internet Explorer\iexplore.exe
                    RemoteAdress: $IPForInternet
                    Protocol: TCP
    ###########################################################################
    "Set default inbound policy to Allow/Open - Learning mode":
        ShortPrefix: GPO,Computer
        Fw:
            DefaultInboundAction: Allow

    ###########################################################################
    "Set default inbound policy to Block":
        ShortPrefix: GPO,Computer
        Fw:
            DefaultInboundAction: Block
            
    ###########################################################################
    "Enable Log & Whitelist bastion admin":
        ShortPrefix: GPO,Computer
        Script: |
            $IP_VPN_ADMIN = '10.10.10.0/24'
        Fw:
            Enabled: True
            NotifyOnListen: False
            DefaultOutboundAction: Allow
            AllowInboundRules: True
            AllowLocalFirewallRules: False
            AllowLocalIPsecRules: True
            AllowUnicastResponseToMulticast: True
            LogAllowed: True
            LogBlocked: True
            LogIgnored: False
            LogFileName: "%windir%\\system32\\logfiles\\pfirewall.log"
            LogMaxSizeKilobytes: 32767
            
            Inbound-Allow:
                WhiteList Bastion: $IP_VPN_ADMIN:*/*
    ###########################################################################
    DHCPServer for everybody:
        ShortPrefix: GPO,Computer
        Fw:
            Inbound-Allow:
                DHCP for users:
                    Protocol: UDP
                    LocalPort: "@(67,2535)"
    ###########################################################################
    DC-Replication:
        ShortPrefix: GPO,Computer
        Script: |
            $domainDontrollerList = (Get-DnsClientGlobalSetting).SuffixSearchList | foreach {
                Resolve-DnsName -Type ALL -Name _ldap._tcp.dc._msdcs.$_
            } | foreach {
                $_.IP4Address
            } | sort -unique
        Fw:
            Inbound-Allow:
                RemoteAddress: $domainDontrollerList
            Outbound-Allow:
                RemoteAddress: $domainDontrollerList
    ###########################################################################
    Wide-Open-DC-Services-TCP:
        ShortPrefix: GPO,Computer
        Fw:
            Inbound-Allow:
                Wide-Open-DC-Services-TCP:
                    Protocol: TCP
                    LocalPort: "@(88,389,445,464,636,3269,3268,9389)"
                Wide-Open-DC-Services-UDP:
                    Protocol: UDP
                    LocalPort: "@(123,88,389,500,2535,67,68)"
                Wide-Open-DC-Services-RPC:
                    Protocol: TCP
                    LocalPort: RPC
                Wide-Open-DC-Services-RPC-EPMAP:
                    Protocol: TCP
                    LocalPort: RPCEPMap
 
###############################################################################
Security:
    ###########################################################################
    SMB server - FileServer configuration:
        ShortPrefix: GPO,Computer
        Hive:
            HKLM\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters:
                SMB1: DWord:0
                EnableSecuritySignature: DWord:1
                RequireSecuritySignature: DWord:1 # 2.3.9.2 Ensure 'Microsoft network server: Digitally sign communications (always)' is set to 'Enabled'
                AutoShareWks: DWord:0
                AutoShareServer: DWord:0
                AutoDisconnect: DWord:60 # Microsoft_network_server_Amount_of_idle_time_required_before_suspending_session
                RestrictNullSessAccess: DWord:1 # Network_access_Shares_that_can_be_accessed_anonymously
            HKLM\System\CurrentControlSet\Services\Rdr\Parameters:
                EnableSecuritySignature: DWord:1
                RequireSecuritySignature: DWord:1
        GPLink: $LDAP_DN

    ###########################################################################
    SMB client configuration:
        ShortPrefix: GPO,Computer
        Hive:
            HKLM\System\CurrentControlSet\Services\LanmanWorkstation\Parameters:
                EnableSecuritySignature: DWord:1 # 2.3.8.2 Ensure 'Microsoft network client: Digitally sign communications (if server agrees)' is set to 'Enabled'
                RequireSecuritySignature: DWord:1 # Microsoft_network_client_Digitally_sign_communications_always
                EnablePlainTextPassword: DWord:0 # Microsoft_network_client_Send_unencrypted_password_to_third_party_SMB_servers
        GPLink: $LDAP_DN
    
    ###########################################################################
    Bitlocker:
        ShortPrefix: GPO,Computer
        Hive:
            HKLM\Software\Policies\Microsoft\FVE:
                ActiveDirectoryBackup: DWord:1
                OSActiveDirectoryBackup: DWord:1
                FDVActiveDirectoryBackup: DWord:1
                RDVActiveDirectoryBackup: DWord:1
                OSRecovery: DWord:1
                RequireActiveDirectoryBackup: DWord:1
                ActiveDirectoryInfoToStore: DWord:1
                EncryptionMethodWithXtsOs: DWord:7
                EncryptionMethodWithXtsFdv: DWord:7
                EncryptionMethodWithXtsRdv: DWord:7
                EncryptionMethodNoDiffuser: DWord:4
                EncryptionMethod: DWord:2

    ###########################################################################
    Windows defender:
        ShortPrefix: GPO,Computer
        Hive:
            HKLM\Software\Policies\Microsoft\Windows Defender\Signature Updates:
                ASSignatureDue: DWord:2
                AVSignatureDue: DWord:2
                DisableUpdateOnStartupWithoutEngine: DWord:0
                ForceUpdateFromMU: DWord:1
                RealtimeSignatureDelivery: DWord:1
                ScheduleDay: DWord:0
                SignatureUpdateInterval: DWord:12
                UpdateOnStartUp: DWord:1
            HKLM\Software\Policies\Microsoft\Windows Defender:
                DisableAntiSpyware: DWord:0
                DisableRoutinelyTakingAction: DWord:0
                PUAProtection: DWord:1
            HKLM\Software\Policies\Microsoft\Windows Defender\Real-Time Protection:
                DisableBehaviorMonitoring: DWord:0
                DisableIOAVProtection: DWord:0
                DisableOnAccessProtection: DWord:0
                DisableRawWriteNotification: DWord:0
                DisableScanOnRealtimeEnable: DWord:0
                RealtimeScanDirection: DWord:0
            HKLM\Software\Policies\Microsoft\Windows Defender\Scan:
                DisableHeuristics: DWord:0
                DisablePackedExeScanning: DWord:0
            HKLM\Software\Policies\Microsoft\Windows Defender\Signature Updates:
                DisableUpdateOnStartupWithoutEngine: DWord:0
            HKLM\Software\Policies\Microsoft\Windows Defender\Windows Defender Exploit Guard\ASR:
                ExploitGuard_ASR_Rules: DWord:1
            HKLM\Software\Policies\Microsoft\Windows Defender\Windows Defender Exploit Guard\ASR\Rules:
                75668C1F-73B5-4CF0-BB93-3ECF5CB7CC84: 1:String # Block Office applications from injecting code into other processes
                D4F940AB-401B-4EFC-AADC-AD5F3C50688A: 1:String # Block Office applications from creating child processes
                92E97FA1-2EDF-4476-BDD6-9DD0B4DDDC7B: 1:String # Block Win32 API calls from Office macro
                3B576869-A4EC-4529-8536-B80A7769E899: 1:String # Block Office applications from creating executable content
                5BEB7EFE-FD9A-4556-801D-275E5FFC04CC: 1:String # Block execution of potentially obfuscated scripts
                BE9BA2D9-53EA-4CDC-84E5-9B1EEEE46550: 1:String # Block executable content from email client and webmail
                D3E037E1-3EB8-44C8-A917-57927947596D: 1:String # Block JavaScript or VBScript from launching downloaded executable content
                C1DB55AB-C21A-4637-BB3F-A12568109D35: 1:String # Use advanced protection against ransomware
                B2B3F03D-6A65-4F7B-A9C7-1C7EF74A9BA4: 1:String # Block untrusted and unsigned processes that run from USB
            HKLM\Software\Policies\Microsoft\Windows Defender\Windows Defender Exploit Guard\Network Protection:
                EnableNetworkProtection: DWord:1
        GPLink: $LDAP_DN
        
    ###########################################################################
    "[CVE] Fix-exploit-kerberos-samaccountname-spoofing #CVE-2021-42287 #CVE-2021-42278":
        ShortPrefix: GPO,Computer
        Script: | 
            #To find any computer accounts that have a invalid SamAccountName property use this query
            Get-ADComputer -Filter { samAccountName -notlike "*$" } | Set-ADComputer -Enabled $false
        Hive:
            HKLM\System\CurrentControlSet\Services\Kdc:
                PacRequestorEnforcement: DWord:2
        GPLink: OU=Domain Controllers,$LDAP_DN
    ###########################################################################
    LDAP client configuration:
        ShortPrefix: GPO,Computer
        Hive:
            HKLM\System\CurrentControlSet\Services\LDAP:
                LDAPClientIntegrity: DWord:2
        GPLink: $LDAP_DN

    ###########################################################################
    LDAP server configuration:
        ShortPrefix: GPO,Computer
        Hive:
            HKLM\System\CurrentControlSet\Services\NTDS\Parameters:
                # Domain controller LDAP server signing requirements
                LDAPServerIntegrity: DWord:2
                # 18.3.5 (L1) Ensure 'Extended Protection for LDAP Authentication (Domain Controllers only)' is set to 'Enabled: Enabled, always (recommended)' (DC Only) (Scored)
                LdapEnforceChannelBinding: DWord:2
        GPLink: OU=Domain Controllers,$LDAP_DN

    ###########################################################################
    "LSASS Protection (Mimikatz)":
        Comment: |
            Protect the process lsass.exe to avoid an attacker to hijack credentials by dumping lsass.exe
            
            Require: Do not deploy on computers that require Smartcard/2FA with DLL not signed by Microsoft            
            Side effect: Block all DLL not signed by Microsoft.
            If disabled: An attacker can abuse of dumping lsass.exe to grab AD credentials of past connections.
            Doc: https://itm4n.github.io/lsass-runasppl/
            
            RunAsPPL=1 => Enforce with UEFI + SecureBoot
            RunAsPPL=2 => Enforce without UEFI + SecureBoot
        ShortPrefix: GPO,Computer
        Hive:
            HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest:
                UseLogonCredential: DWord:0
                Negotiate: DWord:0
            HKLM\SYSTEM\CurrentControlSet\Control\LSA:
                RunAsPPL: DWord:2
                DisableRestrictedAdmin: DWord:0
                DisableRestrictedAdminOutboundCreds: DWord:1
    ###########################################################################
    "LSASS Protection (Mimikatz)(tspkg)":
        Comment: |
            Block credential delegation to avoid an attacker to hijack credentials from lsass.exe
            
            Require: Do not deploy on RDP server that require delegation
            Side effect: Can kill RDP server for delegation.
            If disabled: An attacker can abuse of lsass and rdp service to grab AD credentials of past connections.
            Doc: https://clement.notin.org/blog/2019/07/03/credential-theft-without-admin-or-touching-lsass-with-kekeo-by-abusing-credssp-tspkg-rdp-sso/
        ShortPrefix: GPO,Computer
        Hive:
            HKLM\SOFTWARE\Policies\Microsoft\Windows\CredentialsDelegation:
                AllowDefaultCredentials: DWORD:0
                ConcatenateDefaults_AllowDefault: DWORD:0
                AllowDefCredentialsWhenNTLMOnly: DWORD:0
                ConcatenateDefaults_AllowDefNTLMOnly: DWORD:0
            HKLM\SOFTWARE\Policies\Microsoft\Windows\CredentialsDelegation\AllowDefCredentialsWhenNTLMOnly:
                "1": "String:"
            HKLM\SOFTWARE\Policies\Microsoft\Windows\CredentialsDelegation\AllowDefaultCredentials:
                "1": "String:"

    ###########################################################################
    "WIFI-Protection - AirStrike":
        ShortPrefix: GPO,Computer
        Hive:
            HKLM\SOFTWARE\Policies\Microsoft\Windows\System:
                DontDisplayNetworkSelectionUI: DWord:1
            HKLM\Software\Microsoft\PolicyManager\default\WiFi\AllowAutoConnectToWiFiSenseHotspots:
                value: DWord:0
        GPLink: $LDAP_DN
    ###########################################################################
    Disable print spooler:
        ShortPrefix: GPO,Computer
        Service General Setting:
            Spooler: 4
        GPLink: OU=Domain Controllers,$LDAP_DN

    ###########################################################################
    LLMNR:
        Comment: "Protection against Man-In-The-Middle.\nSide effect: Check first that dns suffix is deployed everywhere"
        ShortPrefix: GPO,Computer
        Hive:
            HKLM\SOFTWARE\Policies\Microsoft\Windows NT\DNSClient:
                EnableMulticast: DWord:0
        Fw:
            Outbound-Block:
                Drop LLMNR:
                    Protocol: UDP
                    RemotePort: 5355
        GPLink: $LDAP_DN
    ###########################################################################
    NetBios:
        Comment: "Protection against Man-In-The-Middle.\nSide effect: Check first that dns suffix is deployed everywhere"
        ShortPrefix: GPO,Computer
        Hive:
            HKLM\SYSTEM\CurrentControlSet\Services\Netbt\Parameters:
                NodeType: DWord:2
        Fw:
            Outbound-Block:
                Drop NetBios:
                    Protocol: UDP
                    RemotePort: 137
        GPLink: $LDAP_DN
    ###########################################################################
    mDNS:
        Comment: "Protection against Man-In-The-Middle.\nSide effect: Check first that dns suffix is deployed everywhere"
        ShortPrefix: GPO,Computer
        Hive:
            HKLM\SYSTEM\CurrentControlSet\Services\Dnscache\Parameters:
                EnableMDNS: DWord:0
        GPLink: $LDAP_DN
    ###########################################################################
    IPv6:
        Comment: "Protection against Man-In-The-Middle.\nSide effect: None"
        ShortPrefix: GPO,Computer
        Hive:
            HKLM\SYSTEM\CurrentControlSet\Services\Tcpip6\Parameters:
                DisabledComponents: DWord:32
        Fw:
            Outbound-Block:
                IPv6:
                    Protocol: IPv6
                IPv6-Frag:
                    Protocol: IPv6-Frag
                IPv6-Route:
                    Protocol: IPv6-Route
                ICMPv6:
                    Protocol: ICMPv6
                IPv6-NoNxt:
                    Protocol: IPv6-NoNxt
                IPv6-Opts:
                    Protocol: IPv6-Opts
                DHCPv6:
                    Protocol: UDP
                    RemotePort: 547
        GPLink: $LDAP_DN
    ###########################################################################
    WPAD:
        Comment: |
            Protection against Man-In-The-Middle.
            
            Require: Check if corp use automatic proxy settings
            Side effect: Can block network communication if WAD proxy is used but not deployed via GPO ou via DNS entry
        ShortPrefix: GPO,Computer
        Hive:
            # => Disable wpad service
            HKLM\SYSTEM\CurrentControlSet\Services\WinHttpAutoProxySvc:
                Start: DWord:4
            HKLM\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Wpad:
                WpadOverride: DWord:1
            HKCU\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Wpad:
                WpadOverride: DWord:1
            HKLM\Software\Microsoft\Windows\CurrentVersion\Internet Settings:
                AutoDetect: DWord:0
            HKCU\Software\Microsoft\Windows\CurrentVersion\Internet Settings:
                AutoDetect: DWord:0
    ###########################################################################
    Windows-LAPSv2:
        Script: |
            # Doc: https://www.it-connect.fr/tuto-configurer-windows-laps-active-directory/
            # Doc: https://learn.microsoft.com/en-us/windows-server/identity/laps/laps-management-policy-settings
            Import-Module LAPS
            # Note admx is at C:\Windows\PolicyDefinitions\LAPS.admx
            # > Computer Configuration > Policies > Administration template > System > LAPS
            Update-LapsADSchema -Verbose
            # Will add the following attributes
            #    msLAPS-PasswordExpirationTime
            #    msLAPS-Password
            #    msLAPS-EncryptedPassword
            #    msLAPS-EncryptedPasswordHistory
            #    msLAPS-EncryptedDSRMPassword
            #    msLAPS-EncryptedDSRMPasswordHistory
            # Allow computers to update their local admin password
            Set-LapsADComputerSelfPermission -Identity "OU=Computers,$LDAP_DN"
            New-ADGroup -Name PRIV_WLAPS_READER -Path "OU=_CriticalUsers,$LDAP_DN" -GroupCategory Security -GroupScope DomainLocal
            Set-LapsADReadPasswordPermission -Identity "OU=Computers,$LDAP_DN" -AllowedPrincipals PRIV_WLAPS_READER
            Set-LapsADAuditing -Identity "OU=Computers,$LDAP_DN" -AuditedPrincipals PRIV_WLAPS_READER -AuditType Success
            #xcopy C:\Windows\PolicyDefinition\LAPS.admx and \en-US\LAPS.adml
            #xcopy C:\Windows\PolicyDefinition\en-US\LAPS.adml \corp.net\SYSVOL\corp.net\Policies\PolicyDefinitions
            #
            # Event: Applications and Services Logs>Microsoft>Windows>LAPS
            #
            # delete LAPS.Legacy agent:
            # > MsiExec.exe /x {EA8CB806-C109-4700-96B4-F1F268E5036C} /qn
            # | Policy name	                | Policy registry key root
            # |=============================|===============================================================
            # | LAPS CSP	                | HKLM\Software\Microsoft\Policies\LAPS
            # | LAPS Group Policy	        | HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\LAPS
            # | LAPS Local Configuration	| HKLM\Software\Microsoft\Windows\CurrentVersion\LAPS\Config
            # | Legacy Microsoft LAPS	    | HKLM\Software\Policies\Microsoft Services\AdmPwd
            #
            # TO force LAPS refresh on a computer:
            # > Invoke-LapsPolicyProcessing
            #
            # Get Password
            # > Get-LapsADPassword "PC-01" -AsPlainText -IncludeHistory
        Comment: |
            Configuration for Windows LAPS (new LAPS)
            
            Require: Check if local admin is not used by scripts/services/schtask
            Side effect: None
        ShortPrefix: GPO,Computer
        Hive:
            # https://learn.microsoft.com/en-us/windows-server/identity/laps/laps-management-policy-settings
            HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\LAPS:
                # 2 = AD
                # 1 = AAD
                # 0 = Disabled
                BackupDirectory: DWord:2
                PasswordAgeDays: DWord:30
                # Default 14
                PasswordLength: DWord:20
                # 4=	Large letters + small letters + numbers + special characters
                PasswordComplexity: DWord:4
                ADPasswordEncryptionEnabled: DWord:0
                ADBackupDSRMPassword: DWord:1
                # Auto reset password after used
                PostAuthenticationResetDelay: DWord:6
                # 1 = Reset Password
                # 2 = Signout
                # 3 = Reset + signout (default)
                # 4 = reboot
                # 5 = reset + reboot
                PostAuthenticationActions: DWord:3
            HKLM\Software\Microsoft\Windows\CurrentVersion\LAPS\Config:
                # 2 = AD
                # 1 = AAD
                # 0 = Disabled
                BackupDirectory: DWord:2
                PasswordAgeDays: DWord:30
                # Default 14
                PasswordLength: DWord:20
                # 4=	Large letters + small letters + numbers + special characters
                PasswordComplexity: DWord:4
                ADPasswordEncryptionEnabled: DWord:0
                ADBackupDSRMPassword: DWord:1
                # Auto reset password after used
                PostAuthenticationResetDelay: DWord:6
                # 1 = Reset Password
                # 2 = Signout
                # 3 = Reset + signout (default)
                # 4 = reboot
                # 5 = reset + reboot
                PostAuthenticationActions: DWord:3
    ###########################################################################
    LAPS.Legacy:
        ShortPrefix: GPO,Computer
        Script: |
            # Installation of LAPS & LAPS UI on the DC
            choco install laps --params='/ALL' -y
            # Update the schema of the AD with new attributes:
            #   ms-MCS-AdmPwd
            #   ms-MCS-AdmPwdExpirationTime
            Import-module AdmPwd.PS
            Update-AdmPwdADSchema
            # Set ACLs to set passwords in ms-Mcs-AdmPwd by SELF (computers)
            Set-AdmPwdComputerSelfPermission -Identity _AllComputers # <Base OU with computers>
            # Create LAPS auto deployement
            New-GPOSchTask -GPOName "[SD][Choco] LAPS" -TaskName "[SD][Choco] LAPS" -TaskType ImmediateTask -Command 'C:\ProgramData\chocolatey\bin\choco.exe' -CommandArguments 'install -y laps'
            # One line full deploy New-GPOSchTask -GPOName "[SD][Choco] LAPS" -TaskName "[SD][Choco] LAPS" -TaskType ImmediateTask -Command "powershell.exe" -CommandArguments '-exec bypass -nop -Command "[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12;iwr https://chocolatey.org/install.ps1 -UseBasicParsing | iex; C:\ProgramData\chocolatey\bin\choco.exe install -y laps"'
            # Grant a group for LAPS of computers of an OU
            ##dsacls "OU=SecretComputers,OU=azerty,DC=corp,DC=local" /G "LAPS_READER_4_SecretComputers:CA;ms-Mcs-AdmPwd"
        Comment: "Configuration for LAPS.Legacy: Every 30 days change local administrator password with a random one with a length of 16 random chars [A-Za-z0-9-+*/*$=)]\nSide effect: None\nNote: Debug mode is enabled for tracking LAPS error"
        ShortPrefix: GPO,Computer
        Hive:
            HKLM\Software\Policies\Microsoft Services\AdmPwd:
                # Enable local admin password management
                AdmPwdEnabled: DWord:1
                # Do not allow password expiration time longer than required by policy
                PwdExpirationProtectionEnabled: DWord:1
                # Set password policy
                PasswordComplexity: DWord:4 
                PasswordLength: DWord:16
                PasswordAgeDays: DWord:30
                
            HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\GPExtensions\{D76B9641-3288-4f75-942D-087DE603E3EA}:
                # Verbose mode, log everything
                ExtensionDebugLevel: DWord:2
    ###########################################################################
    Machine Password Rotation:
        Comment: "Force computer to change their AD password every 30days\nSide effect: None"
        ShortPrefix: GPO,Computer
        Hive:
            HKLM\System\CurrentControlSet\Services\Netlogon\Parameters:
                DisablePasswordChange: DWord:0
                MaximumPasswordAge: DWord:30
        GPLink: $LDAP_DN

    ###########################################################################
    "Network security: Restrict NTLM outgoing authentication for machine account (Coercing)":
        ShortPrefix: GPO,Computer
        Hive:
            HKLM\System\CurrentControlSet\Control\Lsa\MSV1_0:
                # 0) All all; 1) Audit; 2) Disable NetNTLM auth
                RestrictSendingNTLMTraffic: DWord:2
        GPLink: OU=Domain Controllers,$LDAP_DN
    ###########################################################################
    "Network security: Send NTLMv2 response only. Refuse LM & NTLM":
        ShortPrefix: GPO,Computer
        Hive:
            HKLM\System\CurrentControlSet\Control\Lsa:
                LmCompatibilityLevel: DWord:5
                NoLMHash : DWord:1
            #HKLM\System\CurrentControlSet\Control\Lsa\MSV1_0:
            #    ## 2.3.11.9 Ensure 'Network security: Minimum session security for NTLM SSP based (including secure RPC) clients' is set to 'Require NTLMv2 session security, Require 128-bit encryption'
            #    #		'Require NTLMv2 session security'	= '524288'
            #    #		'Require 128-bit encryption'		= '536870912'
            #    #		'Both options checked'				= '537395200'
            #    NTLMMinClientSec: DWord:537395200
            #    ## 2.3.11.10 Ensure 'Network security: Minimum session security for NTLM SSP based (including secure RPC) servers' is set to 'Require NTLMv2 session security, Require 128-bit encryption'
            #    NTLMMinServerSec: DWord:537395200
            #HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System\Kerberos\Parameters:
            #    #		#DES_CBC_CRC  = '1'
            #    #		#DES_CBC_MD5  = '2'
            #    #		#RC4_HMAC_MD5 = '4'
            #    #		#AES128_HMAC_SHA1  = '8'
            #    #		#AES256_HMAC_SHA1  = '16'
            #    SupportedEncryptionTypes: DWord:24
                
        GPLink: $LDAP_DN

    ###########################################################################
    "Encryption & sign communications":
        ShortPrefix: GPO,Computer
        Hive:
            HKLM\System\CurrentControlSet\Services\Netlogon\Parameters:
                RequireSignOrSeal: DWord:1 # Domain_member_Digitally_encrypt_or_sign_secure_channel_data_always
                SealSecureChannel: DWord:1 # Domain_member_Digitally_encrypt_secure_channel_data_when_possible
                SignSecureChannel: DWord:1 # Domain_member_Digitally_sign_secure_channel_data_when_possible
        GPLink: $LDAP_DN
    ###########################################################################
    WindowsUpdate for users:
        ShortPrefix: GPO,Computer
        Hive:
            HKLM\Software\Policies\Microsoft\Windows\WindowsUpdate:
                SetAutoRestartDeadline: DWord:1
                AutoRestartDeadlinePeriodInDays: DWord:3
                AutoRestartDeadlinePeriodInDaysForFeatureUpdates: DWord:3
                SetComplianceDeadline: DWord:1
                ConfigureDeadlineForQualityUpdates: DWord:3
                ConfigureDeadlineGracePeriod: DWord:2
                ConfigureDeadlineForFeatureUpdates: DWord:3
                ConfigureDeadlineGracePeriodForFeatureUpdates: DWord:2
                ConfigureDeadlineNoAutoReboot: DWord:1
                SetActiveHoursMaxRange: DWord:1
                ActiveHoursMaxRange: DWord:18
        
            HKLM\Software\Policies\Microsoft\Windows\WindowsUpdate\AU: #    Auto download and schedule the install
                AUOptions: DWord:4
                AutomaticMaintenanceEnabled: DWord:1 # Install during automatic maintenance
                ScheduledInstallDay: DWord:0 # Scheduled install day: Every day
                ScheduledInstallTime: DWord:12 # Install at 012:00 AM
                ScheduledInstallEveryWeek: DWord:1 # If you have selected "4 - Auto download and schedule the install" for your scheduled install day and specified a schedule, you also have the option to limit updating to a weekly, bi-weekly or monthly occurrence, using the options below: Every week
                AllowMUUpdateService: DWord:1 # Install updates for other Microsoft products
                AutoInstallMinorUpdates: DWord:1
                IncludeRecommendedUpdates: DWord:1
    ###########################################################################
    WindowsUpdate for servers:
        ShortPrefix: GPO,Computer
        Hive:
            HKLM\Software\Policies\Microsoft\Windows\WindowsUpdate:
                SetActiveHoursMaxRange: DWord:1
                ActiveHoursMaxRange: DWord:18
                # Auto download and schedule the install
            HKLM\Software\Policies\Microsoft\Windows\WindowsUpdate\AU:
                AUOptions: DWord:4                
                AutomaticMaintenanceEnabled: DWord:1 # Install during automatic maintenance                
                ScheduledInstallDay: DWord:0 # Scheduled install day: Every day                
                ScheduledInstallTime: DWord:3 # Install at 03:00 AM                
                ScheduledInstallEveryWeek: DWord:1 # If you have selected "4 - Auto download and schedule the install" for your scheduled install day and specified a schedule, you also have the option to limit updating to a weekly, bi-weekly or monthly occurrence, using the options below: Every week                
                AllowMUUpdateService: DWord:1 # Install updates for other Microsoft products
                AutoInstallMinorUpdates: DWord:1
                IncludeRecommendedUpdates: DWord:1




###############################################################################
NiceToHave:
    ###########################################################################
    Unlimited Path length:
        ShortPrefix: GPO,Computer
        Comment: |
            Allow long path in Windows, usefull for SMB share for users.
            
            Side effect: None
            If disabled: Can block access to some ressource on SMB that have long path
        Hive:
            HKLM\SYSTEM\CurrentControlSet\Control\FileSystem:
                LongPathsEnabled: DWord:1
        GPLink: $LDAP_DN
        
    DNS Suffix:
        ShortPrefix: GPO,Computer
        Comment: |
            The typical name resolution process for Microsoft Windows 2000 uses the primary DNS suffix and any connection-specific DNS suffixes. If these suffixes do not work, the devolution of the primary DNS suffix is attempted by the name resolution process.
            
            When a domain suffix search list is configured on a client, only that list is used. The primary DNS suffix and any connection-specific DNS suffixes are not used, nor is the devolution of the primary suffix attempted. The domain suffix search list is an administrative override of all standard Domain Name Resolver (DNR) look-up mechanisms.
            
            Side effect: None
            If disabled: Can block access to some ressource that doesn't known AD Suffix
        Hive:
            HKLM\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters:
                SearchList: String:suffix-dns.mycorp.local,suffix2.corp.lo
            HKLM\SOFTWARE\Policies\Microsoft\Windows NT\DNSClient:
                SearchList: String:suffix-dns.mycorp.local,suffix2.corp.lo

###############################################################################
Azure:
    ###########################################################################
    Deny AzureAD autojoin via Teams:
        ShortPrefix: GPO&Pref,Computer
        Comment: |
            Deny Teams&co to autojoin device to AzureAD
            
            To detect if the computer/user is AAD auto join:
            1) Check:
                dsregcmd.exe /debug /status
            2) Unenroll:
                dsregcmd.exe /debug /leave (as SYSTEM)
            3) Reinstall "Microsoft.AAD.BrokerPlugin" in the context of the user session
                Add-AppxPackage -Register "C:\Windows\SystemApps\Microsoft.AAD.BrokerPlugin_cw5n1h2txyewy\Appxmanifest.xml" -DisableDevelopmentMode -ForceApplicationShutdown
            4) Clear all "Microsoft.AAD.BrokerPlugin" cache (as local ADMIN)
                Get-ItemProperty -Path "C:\Users\*\AppData\Local\Packages\Microsoft.AAD.BrokerPlugin*" | %{ rmdir /q /s "$($_.FullName)" } | Out-Null 
            
            WARNING! Do not disable DisableAADWAM or EnableADAL, it will kill the MFA on Azure, all account with WFA will not work anymore
            
            To avoid device to auto join in AAD, configure AAD. In AAD/Microsoft-Entra go to Identity > Devices > All devices > Device settings
                - "Users may join devices to Microsoft Entra ID": SELECTED (only dedicated user)
                - "Additional local administrators on Microsoft Entra joined devices": NONE
                - "Require multifactor authentication (MFA) to join devices": YES
            
            Side effect: Take the computer out of AAD but not from AD
            If disabled: Will allow Teams & co to auto-enroll the device. Will not autojoin to AAD
            Doc: https://techpress.net/how-to-unjoin-a-hybrid-azure-ad-join-device/
            Doc: To fix the unpredictable freez of Office apps (Outlook/Teams/OneDrive): http://aldrid.ge/W10MU-AAD-Auth
        Hive:
            HKLM\SOFTWARE\Policies\Microsoft\Windows\WorkplaceJoin:
                BlockAADWorkplaceJoin: DWord:1
                autoWorkplaceJoin: DWord:0
        Tasks:
            Unjoin AAD:
               Type: ImmediateTask
               Command: dsregcmd
               CommandArguments: /debug /leave
               
Audit:
    Audit LDAP SASL:
        ShortPrefix: GPO,Computer
        Comment: |
            Log missing LDAP SASL.
            => Event ID of 2889 in the Directory Service log.
            
            Monitoring for LDAP Binding without Channel Binding.
            => Event ID 3039 in the Directory Service event log.
            
            Pump the size of Directory Service log to 32MB. The default size is 1MB
            
            $Hours = 24
            $DCs = Get-ADDomainController -filter *
            $InsecureLDAPBinds = @()
            ForEach ($DC in $DCs) {
            $Events = Get-WinEvent -ComputerName $DC.Hostname -FilterHashtable @{Logname='Directory Service';Id=2889; StartTime=(Get-Date).AddHours('-$Hours')}
            ForEach ($Event in $Events) {
               $eventXML = [xml]$Event.ToXml()
               $Client = ($eventXML.event.EventData.Data[0])
               $IPAddress = $Client.SubString(0,$Client.LastIndexOf(':'))
               $User = $eventXML.event.EventData.Data[1]
               Switch ($eventXML.event.EventData.Data[2])
                  {
                  0 {$BindType = 'Unsigned'}
                  1 {$BindType = 'Simple'}
                  }
               $Row = '' | select IPAddress,User,BindType
               $Row.IPAddress = $IPAddress
               $Row.User = $User
               $Row.BindType = $BindType
               $InsecureLDAPBinds += $Row
               }
            }
            $InsecureLDAPBinds | Out-Gridview
        Hive:
            HKLM\SYSTEM\CurrentControlSet\Services\NTDS\Diagnostics:
                16 LDAP Interface Events: DWord:2
            HKLM\SYSTEM\CurrentControlSet\Services\EventLog\Directory Service:
                MaxSize: DWord:33685504
                MaxSizeUpper: DWord:0                
            HKLM\SYSTEM\CurrentControlSet\Policies\Microsoft\FeatureManagement\Overrides:
                1775223437: DWord:1
                2654580365: DWord:1
            HKLM\SYSTEM\CurrentControlSet\Services\NTDS\Parameters:
                LdapEnforceChannelBinding: DWord:1
    Syslog:
        Tasks:
            Syslog:
               Type: Task
               Command: powershell
               CommandArguments: -exec bypass -nop -Command \\dc01.corp.lo\sysvol\dc01.corp.lo\scripts\logger.ps1
               RunAs: S-1-5-18
               Context: Machine
               StartEveryDayAt: 9
               disallowStartIfOnBatteries: false
               stopIfGoingOnBatteries: false
               executionTimeLimit: 1        # in hours
               restartOnFailureInterval: 10 # in minutes
               restartOnFailureCount: 3
               runOnlyIfNetworkAvailable: true
               randomDelay: 10              # in minutes. if 0 => no random delay
